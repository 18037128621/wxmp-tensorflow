"use strict";var t=require("../../chunks/tfjs.js");function e(t,e,n,o){return new(n||(n=Promise))((function(r,i){function a(t){try{l(o.next(t))}catch(t){i(t)}}function s(t){try{l(o.throw(t))}catch(t){i(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,s)}l((o=o.apply(t,e||[])).next())}))}function n(t,e){var n,o,r,i,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(r=(r=a.trys).length>0&&r[r.length-1])&&(6===i[0]||2===i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(t){i=[6,t],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}var o=function(e){return{startEndTensor:e,startPoint:t.slice(e,[0,0],[-1,2]),endPoint:t.slice(e,[0,2],[-1,2])}},r={strides:[8,16],anchors:[2,6]};function i(e,n){var o,r,i;if(e.topLeft instanceof t.Tensor&&e.bottomRight instanceof t.Tensor){var a=t.tidy((function(){return[t.concat([t.slice(t.sub(n-1,e.topLeft),0,1),t.slice(e.topLeft,1,1)]),t.concat([t.sub(n-1,t.slice(e.bottomRight,0,1)),t.slice(e.bottomRight,1,1)])]}));o=a[0],r=a[1],null!=e.landmarks&&(i=t.tidy((function(){var o=t.sub(t.tensor1d([n-1,0]),e.landmarks),r=t.tensor1d([1,-1]);return t.mul(o,r)})))}else{var s=e.topLeft,l=s[0],c=s[1],u=e.bottomRight,h=u[0],d=u[1];o=[n-1-l,c],r=[n-1-h,d],null!=e.landmarks&&(i=e.landmarks.map((function(t){return[n-1-t[0],t[1]]})))}var f={topLeft:o,bottomRight:r};return null!=i&&(f.landmarks=i),null!=e.probability&&(f.probability=e.probability instanceof t.Tensor?e.probability.clone():e.probability),f}function a(e,n){return t.tidy((function(){var r;return r=e.hasOwnProperty("box")?e.box:e,t.squeeze(function(e,n){var r=t.mul(e.startPoint,n),i=t.mul(e.endPoint,n),a=t.concat2d([r,i],1);return o(a)}(r,n).startEndTensor)}))}var s=function(){function s(e,n,o,i,a,s){this.blazeFaceModel=e,this.width=n,this.height=o,this.maxFaces=i,this.anchorsData=function(t,e,n){for(var o=[],r=0;r<n.strides.length;r++)for(var i=n.strides[r],a=Math.floor((e+i-1)/i),s=Math.floor((t+i-1)/i),l=n.anchors[r],c=0;c<a;c++)for(var u=i*(c+.5),h=0;h<s;h++)for(var d=i*(h+.5),f=0;f<l;f++)o.push([d,u]);return o}(n,o,r),this.anchors=t.tensor2d(this.anchorsData),this.inputSizeData=[n,o],this.inputSize=t.tensor1d([n,o]),this.iouThreshold=a,this.scoreThreshold=s}return s.prototype.getBoundingBoxes=function(r,i,a){return void 0===a&&(a=!0),e(this,void 0,void 0,(function(){var s,l,c,u,h,d,f,p,b,v,m,y,g,w,x=this;return n(this,(function(k){switch(k.label){case 0:return s=t.tidy((function(){var e=t.image.resizeBilinear(r,[x.width,x.height]),n=t.mul(t.sub(t.div(e,255),.5),2),o=x.blazeFaceModel.predict(n),i=t.squeeze(o),a=function(e,n,o){var r=t.slice(e,[0,1],[-1,2]),i=t.add(r,n),a=t.slice(e,[0,3],[-1,2]),s=t.div(a,o),l=t.div(i,o),c=t.div(s,2),u=t.sub(l,c),h=t.add(l,c),d=t.mul(u,o),f=t.mul(h,o);return t.concat2d([d,f],1)}(i,x.anchors,x.inputSize),s=t.slice(i,[0,0],[-1,1]);return[i,a,t.squeeze(t.sigmoid(s))]})),l=s[0],c=s[1],u=s[2],h=console.warn,console.warn=function(){},d=t.image.nonMaxSuppression(c,u,this.maxFaces,this.iouThreshold,this.scoreThreshold),console.warn=h,[4,d.array()];case 1:return f=k.sent(),d.dispose(),p=f.map((function(e){return t.slice(c,[e,0],[1,-1])})),i?[3,3]:[4,Promise.all(p.map((function(t){return e(x,void 0,void 0,(function(){var e;return n(this,(function(n){switch(n.label){case 0:return[4,t.array()];case 1:return e=n.sent(),t.dispose(),[2,e]}}))}))})))];case 2:p=k.sent(),k.label=3;case 3:for(b=r.shape[1],v=r.shape[2],m=i?t.div([v,b],this.inputSize):[v/this.inputSizeData[0],b/this.inputSizeData[1]],y=[],g=function(e){var n=p[e],r=t.tidy((function(){var r=o(n instanceof t.Tensor?n:t.tensor2d(n));if(!a)return r;var s,c=f[e];return s=i?t.slice(x.anchors,[c,0],[1,2]):x.anchorsData[c],{box:r,landmarks:t.reshape(t.squeeze(t.slice(l,[c,5],[1,-1])),[6,-1]),probability:t.slice(u,[c],[1]),anchor:s}}));y.push(r)},w=0;w<p.length;w++)g(w);return c.dispose(),u.dispose(),l.dispose(),[2,{boxes:y,scaleFactor:m}]}}))}))},s.prototype.estimateFaces=function(o,r,s,l){return void 0===r&&(r=!1),void 0===s&&(s=!1),void 0===l&&(l=!0),e(this,void 0,void 0,(function(){var c,u,h,d,f,p,b=this;return n(this,(function(v){switch(v.label){case 0:return c=function(e){return e instanceof t.Tensor?[e.shape[0],e.shape[1]]:[e.height,e.width]}(o),u=c[1],h=t.tidy((function(){return o instanceof t.Tensor||(o=t.fromPixels(o)),t.expandDims(t.cast(o,"float32"),0)})),[4,this.getBoundingBoxes(h,r,l)];case 1:return d=v.sent(),f=d.boxes,p=d.scaleFactor,h.dispose(),r?[2,f.map((function(e){var n=a(e,p),o={topLeft:t.slice(n,[0],[2]),bottomRight:t.slice(n,[2],[2])};if(l){var r=e,c=r.landmarks,h=r.probability,d=r.anchor,f=t.mul(t.add(c,d),p);o.landmarks=f,o.probability=h}return s&&(o=i(o,u)),o}))]:[2,Promise.all(f.map((function(t){return e(b,void 0,void 0,(function(){var o,r,c,h,d,f,b,v,m,y,g,w=this;return n(this,(function(x){switch(x.label){case 0:return o=a(t,p),l?[3,2]:[4,o.array()];case 1:return d=x.sent(),r={topLeft:d.slice(0,2),bottomRight:d.slice(2)},[3,4];case 2:return[4,Promise.all([t.landmarks,o,t.probability].map((function(t){return e(w,void 0,void 0,(function(){return n(this,(function(e){return[2,t.array()]}))}))})))];case 3:c=x.sent(),h=c[0],d=c[1],f=c[2],b=t.anchor,m=(v=p)[0],y=v[1],g=h.map((function(t){return[(t[0]+b[0])*m,(t[1]+b[1])*y]})),r={topLeft:d.slice(0,2),bottomRight:d.slice(2),landmarks:g,probability:f},function(t){t.startEndTensor.dispose(),t.startPoint.dispose(),t.endPoint.dispose()}(t.box),t.landmarks.dispose(),t.probability.dispose(),x.label=4;case 4:return o.dispose(),s&&(r=i(r,u)),[2,r]}}))}))})))]}}))}))},s}();function l(t){let e,n=t[0],o=1;for(;o<t.length;){const r=t[o],i=t[o+1];if(o+=2,("optionalAccess"===r||"optionalCall"===r)&&null==n)return;"access"===r||"optionalAccess"===r?(e=n,n=i(n)):"call"!==r&&"optionalCall"!==r||(n=i(((...t)=>n.call(e,...t))),e=void 0)}return n}Page({helper:null,async onReady(){console.log("blazeface onReady"),await t.ready(),console.log("tf ready");const o=this.selectComponent("#helper");console.log("blazeface load start");const r=await function(o){var r=void 0===o?{}:o,i=r.maxFaces,a=void 0===i?10:i,l=r.inputWidth,c=void 0===l?128:l,u=r.inputHeight,h=void 0===u?128:u,d=r.iouThreshold,f=void 0===d?.3:d,p=r.scoreThreshold,b=void 0===p?.75:p,v=r.modelUrl;return e(this,void 0,void 0,(function(){var e;return n(this,(function(n){switch(n.label){case 0:return null==v?[3,2]:[4,t.loadGraphModel(v)];case 1:return e=n.sent(),[3,4];case 2:return[4,t.loadGraphModel("https://cdn.static.oppenlab.com/weblf/test/blazeface/model.json",{fromTFHub_:!0})];case 3:e=n.sent(),n.label=4;case 4:return[2,new s(e,c,h,a,f,b)]}}))}))}();console.log("blazeface load end"),o.set({onFrame:async(t,e)=>{const{ctx:n}=e,i={width:t.width,height:t.height,data:new Uint8Array(t.data)},a=await r.estimateFaces(i,!1,!1,!0);if(o.drawCanvas2D(t),a.length>0)for(let t=0;t<a.length;t++){const e=a[t].topLeft,o=a[t].bottomRight,r=[o[0]-e[0],o[1]-e[1]];n.fillStyle="rgba(255, 0, 0, 0.5)",n.fillRect(e[0],e[1],r[0],r[1]);{const e=a[t].landmarks;n.fillStyle="blue";for(let t=0;t<e.length;t++){const o=e[t][0],r=e[t][1];n.fillRect(o,r,5,5)}}}}}),this.helper=o},onShow:function(){l([this,"access",t=>t.helper,"optionalAccess",t=>t.start,"call",t=>t()])},onHide:function(){l([this,"access",t=>t.helper,"optionalAccess",t=>t.stop,"call",t=>t()])},onUnload:function(){},onShareAppMessage:function(){}});
