"use strict";var index=require("../../chunks/index.js");var tfjs=require("../../chunks/tfjs.js");const MESH_ANNOTATIONS={silhouette:[10,338,297,332,284,251,389,356,454,323,361,288,397,365,379,378,400,377,152,148,176,149,150,136,172,58,132,93,234,127,162,21,54,103,67,109],lipsUpperOuter:[61,185,40,39,37,0,267,269,270,409,291],lipsLowerOuter:[146,91,181,84,17,314,405,321,375,291],lipsUpperInner:[78,191,80,81,82,13,312,311,310,415,308],lipsLowerInner:[78,95,88,178,87,14,317,402,318,324,308],rightEyeUpper0:[246,161,160,159,158,157,173],rightEyeLower0:[33,7,163,144,145,153,154,155,133],rightEyeUpper1:[247,30,29,27,28,56,190],rightEyeLower1:[130,25,110,24,23,22,26,112,243],rightEyeUpper2:[113,225,224,223,222,221,189],rightEyeLower2:[226,31,228,229,230,231,232,233,244],rightEyeLower3:[143,111,117,118,119,120,121,128,245],rightEyebrowUpper:[156,70,63,105,66,107,55,193],rightEyebrowLower:[35,124,46,53,52,65],rightEyeIris:[473,474,475,476,477],leftEyeUpper0:[466,388,387,386,385,384,398],leftEyeLower0:[263,249,390,373,374,380,381,382,362],leftEyeUpper1:[467,260,259,257,258,286,414],leftEyeLower1:[359,255,339,254,253,252,256,341,463],leftEyeUpper2:[342,445,444,443,442,441,413],leftEyeLower2:[446,261,448,449,450,451,452,453,464],leftEyeLower3:[372,340,346,347,348,349,350,357,465],leftEyebrowUpper:[383,300,293,334,296,336,285,417],leftEyebrowLower:[265,353,276,283,282,295],leftEyeIris:[468,469,470,471,472],midwayBetweenEyes:[168],noseTip:[1],noseBottom:[2],noseRightCorner:[98],noseLeftCorner:[327],rightCheek:[205],leftCheek:[425]};function scaleBoxCoordinates(box,factor){const startPoint=[box.startPoint[0]*factor[0],box.startPoint[1]*factor[1]];const endPoint=[box.endPoint[0]*factor[0],box.endPoint[1]*factor[1]];return{startPoint:startPoint,endPoint:endPoint}}function getBoxSize(box){return[Math.abs(box.endPoint[0]-box.startPoint[0]),Math.abs(box.endPoint[1]-box.startPoint[1])]}function getBoxCenter(box){return[box.startPoint[0]+(box.endPoint[0]-box.startPoint[0])/2,box.startPoint[1]+(box.endPoint[1]-box.startPoint[1])/2]}function cutBoxFromImageAndResize(box,image,cropSize){const h=image.shape[1];const w=image.shape[2];const boxes=[[box.startPoint[1]/h,box.startPoint[0]/w,box.endPoint[1]/h,box.endPoint[0]/w]];return tfjs.image.cropAndResize(image,boxes,[0],cropSize,"bilinear",0)}function enlargeBox(box,factor=1.5){const center=getBoxCenter(box);const size=getBoxSize(box);const newHalfSize=[factor*size[0]/2,factor*size[1]/2];const startPoint=[center[0]-newHalfSize[0],center[1]-newHalfSize[1]];const endPoint=[center[0]+newHalfSize[0],center[1]+newHalfSize[1]];return{startPoint:startPoint,endPoint:endPoint,landmarks:box.landmarks}}function squarifyBox(box){const centers=getBoxCenter(box);const size=getBoxSize(box);const maxEdge=Math.max(...size);const halfSize=maxEdge/2;const startPoint=[centers[0]-halfSize,centers[1]-halfSize];const endPoint=[centers[0]+halfSize,centers[1]+halfSize];return{startPoint:startPoint,endPoint:endPoint,landmarks:box.landmarks}}const IDENTITY_MATRIX=[[1,0,0],[0,1,0],[0,0,1]];function normalizeRadians(angle){return angle-2*Math.PI*Math.floor((angle+Math.PI)/(2*Math.PI))}function computeRotation(point1,point2){const radians=Math.PI/2-Math.atan2(-(point2[1]-point1[1]),point2[0]-point1[0]);return normalizeRadians(radians)}function buildTranslationMatrix(x,y){return[[1,0,x],[0,1,y],[0,0,1]]}function dot(v1,v2){let product=0;for(let i=0;i<v1.length;i++){product+=v1[i]*v2[i]}return product}function getColumnFrom2DArr(arr,columnIndex){const column=[];for(let i=0;i<arr.length;i++){column.push(arr[i][columnIndex])}return column}function multiplyTransformMatrices(mat1,mat2){const product=[];const size=mat1.length;for(let row=0;row<size;row++){product.push([]);for(let col=0;col<size;col++){product[row].push(dot(mat1[row],getColumnFrom2DArr(mat2,col)))}}return product}function buildRotationMatrix(rotation,center){const cosA=Math.cos(rotation);const sinA=Math.sin(rotation);const rotationMatrix=[[cosA,-sinA,0],[sinA,cosA,0],[0,0,1]];const translationMatrix=buildTranslationMatrix(center[0],center[1]);const translationTimesRotation=multiplyTransformMatrices(translationMatrix,rotationMatrix);const negativeTranslationMatrix=buildTranslationMatrix(-center[0],-center[1]);return multiplyTransformMatrices(translationTimesRotation,negativeTranslationMatrix)}function invertTransformMatrix(matrix){const rotationComponent=[[matrix[0][0],matrix[1][0]],[matrix[0][1],matrix[1][1]]];const translationComponent=[matrix[0][2],matrix[1][2]];const invertedTranslation=[-dot(rotationComponent[0],translationComponent),-dot(rotationComponent[1],translationComponent)];return[rotationComponent[0].concat(invertedTranslation[0]),rotationComponent[1].concat(invertedTranslation[1]),[0,0,1]]}function rotatePoint(homogeneousCoordinate,rotationMatrix){return[dot(homogeneousCoordinate,rotationMatrix[0]),dot(homogeneousCoordinate,rotationMatrix[1])]}const LANDMARKS_COUNT=468;const UPDATE_REGION_OF_INTEREST_IOU_THRESHOLD=.25;const MESH_MOUTH_INDEX=13;const MESH_KEYPOINTS_LINE_OF_SYMMETRY_INDICES=[MESH_MOUTH_INDEX,MESH_ANNOTATIONS["midwayBetweenEyes"][0]];const BLAZEFACE_MOUTH_INDEX=3;const BLAZEFACE_NOSE_INDEX=2;const BLAZEFACE_KEYPOINTS_LINE_OF_SYMMETRY_INDICES=[BLAZEFACE_MOUTH_INDEX,BLAZEFACE_NOSE_INDEX];const LEFT_EYE_OUTLINE=MESH_ANNOTATIONS["leftEyeLower0"];const LEFT_EYE_BOUNDS=[LEFT_EYE_OUTLINE[0],LEFT_EYE_OUTLINE[LEFT_EYE_OUTLINE.length-1]];const RIGHT_EYE_OUTLINE=MESH_ANNOTATIONS["rightEyeLower0"];const RIGHT_EYE_BOUNDS=[RIGHT_EYE_OUTLINE[0],RIGHT_EYE_OUTLINE[RIGHT_EYE_OUTLINE.length-1]];const IRIS_UPPER_CENTER_INDEX=3;const IRIS_LOWER_CENTER_INDEX=4;const IRIS_IRIS_INDEX=71;const IRIS_NUM_COORDINATES=76;const ENLARGE_EYE_RATIO=2.3;const IRIS_MODEL_INPUT_SIZE=64;const MESH_TO_IRIS_INDICES_MAP=[{key:"EyeUpper0",indices:[9,10,11,12,13,14,15]},{key:"EyeUpper1",indices:[25,26,27,28,29,30,31]},{key:"EyeUpper2",indices:[41,42,43,44,45,46,47]},{key:"EyeLower0",indices:[0,1,2,3,4,5,6,7,8]},{key:"EyeLower1",indices:[16,17,18,19,20,21,22,23,24]},{key:"EyeLower2",indices:[32,33,34,35,36,37,38,39,40]},{key:"EyeLower3",indices:[54,55,56,57,58,59,60,61,62]},{key:"EyebrowUpper",indices:[63,64,65,66,67,68,69,70]},{key:"EyebrowLower",indices:[48,49,50,51,52,53]}];function replaceRawCoordinates(rawCoords,newCoords,prefix,keys){for(let i=0;i<MESH_TO_IRIS_INDICES_MAP.length;i++){const{key:key,indices:indices}=MESH_TO_IRIS_INDICES_MAP[i];const originalIndices=MESH_ANNOTATIONS[`${prefix}${key}`];const shouldReplaceAllKeys=keys==null;if(shouldReplaceAllKeys||keys.includes(key)){for(let j=0;j<indices.length;j++){const index=indices[j];rawCoords[originalIndices[j]]=[newCoords[index][0],newCoords[index][1],(newCoords[index][2]+rawCoords[originalIndices[j]][2])/2]}}}}class Pipeline{constructor(boundingBoxDetector,meshDetector,meshWidth,meshHeight,maxContinuousChecks,maxFaces,irisModel){this.regionsOfInterest=[];this.runsWithoutFaceDetector=0;this.boundingBoxDetector=boundingBoxDetector;this.meshDetector=meshDetector;this.irisModel=irisModel;this.meshWidth=meshWidth;this.meshHeight=meshHeight;this.maxContinuousChecks=maxContinuousChecks;this.maxFaces=maxFaces}transformRawCoords(rawCoords,box,angle,rotationMatrix){const boxSize=getBoxSize({startPoint:box.startPoint,endPoint:box.endPoint});const scaleFactor=[boxSize[0]/this.meshWidth,boxSize[1]/this.meshHeight];const coordsScaled=rawCoords.map((coord=>[scaleFactor[0]*(coord[0]-this.meshWidth/2),scaleFactor[1]*(coord[1]-this.meshHeight/2),coord[2]]));const coordsRotationMatrix=buildRotationMatrix(angle,[0,0]);const coordsRotated=coordsScaled.map((coord=>[...rotatePoint(coord,coordsRotationMatrix),coord[2]]));const inverseRotationMatrix=invertTransformMatrix(rotationMatrix);const boxCenter=[...getBoxCenter({startPoint:box.startPoint,endPoint:box.endPoint}),1];const originalBoxCenter=[dot(boxCenter,inverseRotationMatrix[0]),dot(boxCenter,inverseRotationMatrix[1])];return coordsRotated.map((coord=>[coord[0]+originalBoxCenter[0],coord[1]+originalBoxCenter[1],coord[2]]))}getLeftToRightEyeDepthDifference(rawCoords){const leftEyeZ=rawCoords[LEFT_EYE_BOUNDS[0]][2];const rightEyeZ=rawCoords[RIGHT_EYE_BOUNDS[0]][2];return leftEyeZ-rightEyeZ}getEyeBox(rawCoords,face,eyeInnerCornerIndex,eyeOuterCornerIndex,flip=false){const box=squarifyBox(enlargeBox(this.calculateLandmarksBoundingBox([rawCoords[eyeInnerCornerIndex],rawCoords[eyeOuterCornerIndex]]),ENLARGE_EYE_RATIO));const boxSize=getBoxSize(box);let crop=tfjs.image.cropAndResize(face,[[box.startPoint[1]/this.meshHeight,box.startPoint[0]/this.meshWidth,box.endPoint[1]/this.meshHeight,box.endPoint[0]/this.meshWidth]],[0],[IRIS_MODEL_INPUT_SIZE,IRIS_MODEL_INPUT_SIZE]);if(flip){crop=tfjs.image.flipLeftRight(crop)}return{box:box,boxSize:boxSize,crop:crop}}getEyeCoords(eyeData,eyeBox,eyeBoxSize,flip=false){const eyeRawCoords=[];for(let i=0;i<IRIS_NUM_COORDINATES;i++){const x=eyeData[i*3];const y=eyeData[i*3+1];const z=eyeData[i*3+2];eyeRawCoords.push([(flip?1-x/IRIS_MODEL_INPUT_SIZE:x/IRIS_MODEL_INPUT_SIZE)*eyeBoxSize[0]+eyeBox.startPoint[0],y/IRIS_MODEL_INPUT_SIZE*eyeBoxSize[1]+eyeBox.startPoint[1],z])}return{rawCoords:eyeRawCoords,iris:eyeRawCoords.slice(IRIS_IRIS_INDEX)}}getAdjustedIrisCoords(rawCoords,irisCoords,direction){const upperCenterZ=rawCoords[MESH_ANNOTATIONS[`${direction}EyeUpper0`][IRIS_UPPER_CENTER_INDEX]][2];const lowerCenterZ=rawCoords[MESH_ANNOTATIONS[`${direction}EyeLower0`][IRIS_LOWER_CENTER_INDEX]][2];const averageZ=(upperCenterZ+lowerCenterZ)/2;return irisCoords.map(((coord,i)=>{let z=averageZ;if(i===2){z=upperCenterZ}else if(i===4){z=lowerCenterZ}return[coord[0],coord[1],z]}))}predict(input,predictIrises){if(this.shouldUpdateRegionsOfInterest()){const returnTensors=false;const annotateFace=true;const{boxes:boxes,scaleFactor:scaleFactor}=this.boundingBoxDetector.getBoundingBoxes(input,returnTensors,annotateFace);if(boxes.length===0){this.regionsOfInterest=[];return null}const scaledBoxes=boxes.map((prediction=>{const predictionBoxCPU={startPoint:tfjs.squeeze(prediction.box.startPoint).arraySync(),endPoint:tfjs.squeeze(prediction.box.endPoint).arraySync()};const scaledBox=scaleBoxCoordinates(predictionBoxCPU,scaleFactor);const enlargedBox=enlargeBox(scaledBox);const squarifiedBox=squarifyBox(enlargedBox);return{...squarifiedBox,landmarks:prediction.landmarks.arraySync()}}));boxes.forEach((box=>{if(box!=null&&box.startPoint!=null){box.startEndTensor.dispose();box.startPoint.dispose();box.endPoint.dispose()}}));this.updateRegionsOfInterest(scaledBoxes);this.runsWithoutFaceDetector=0}else{this.runsWithoutFaceDetector++}return tfjs.tidy((()=>this.regionsOfInterest.map(((box,i)=>{let angle=0;const boxLandmarksFromMeshModel=box.landmarks.length>=LANDMARKS_COUNT;let[indexOfMouth,indexOfForehead]=MESH_KEYPOINTS_LINE_OF_SYMMETRY_INDICES;if(boxLandmarksFromMeshModel===false){[indexOfMouth,indexOfForehead]=BLAZEFACE_KEYPOINTS_LINE_OF_SYMMETRY_INDICES}angle=computeRotation(box.landmarks[indexOfMouth],box.landmarks[indexOfForehead]);const faceCenter=getBoxCenter({startPoint:box.startPoint,endPoint:box.endPoint});const faceCenterNormalized=[faceCenter[0]/input.shape[2],faceCenter[1]/input.shape[1]];let rotatedImage=input;let rotationMatrix=IDENTITY_MATRIX;if(angle!==0){rotatedImage=tfjs.image.rotateWithOffset(input,angle,0,faceCenterNormalized);rotationMatrix=buildRotationMatrix(-angle,faceCenter)}const boxCPU={startPoint:box.startPoint,endPoint:box.endPoint};const face=tfjs.div(cutBoxFromImageAndResize(boxCPU,rotatedImage,[this.meshHeight,this.meshWidth]),255);const[,flag,coords]=this.meshDetector.predict(face);const coordsReshaped=tfjs.reshape(coords,[-1,3]);let rawCoords=coordsReshaped.arraySync();if(predictIrises){const{box:leftEyeBox,boxSize:leftEyeBoxSize,crop:leftEyeCrop}=this.getEyeBox(rawCoords,face,LEFT_EYE_BOUNDS[0],LEFT_EYE_BOUNDS[1],true);const{box:rightEyeBox,boxSize:rightEyeBoxSize,crop:rightEyeCrop}=this.getEyeBox(rawCoords,face,RIGHT_EYE_BOUNDS[0],RIGHT_EYE_BOUNDS[1]);const eyePredictions=this.irisModel.predict(tfjs.concat([leftEyeCrop,rightEyeCrop]));const eyePredictionsData=eyePredictions.dataSync();const leftEyeData=eyePredictionsData.slice(0,IRIS_NUM_COORDINATES*3);const{rawCoords:leftEyeRawCoords,iris:leftIrisRawCoords}=this.getEyeCoords(leftEyeData,leftEyeBox,leftEyeBoxSize,true);const rightEyeData=eyePredictionsData.slice(IRIS_NUM_COORDINATES*3);const{rawCoords:rightEyeRawCoords,iris:rightIrisRawCoords}=this.getEyeCoords(rightEyeData,rightEyeBox,rightEyeBoxSize);const leftToRightEyeDepthDifference=this.getLeftToRightEyeDepthDifference(rawCoords);if(Math.abs(leftToRightEyeDepthDifference)<30){replaceRawCoordinates(rawCoords,leftEyeRawCoords,"left");replaceRawCoordinates(rawCoords,rightEyeRawCoords,"right")}else if(leftToRightEyeDepthDifference<1){replaceRawCoordinates(rawCoords,leftEyeRawCoords,"left",["EyeUpper0","EyeLower0"])}else{replaceRawCoordinates(rawCoords,rightEyeRawCoords,"right",["EyeUpper0","EyeLower0"])}const adjustedLeftIrisCoords=this.getAdjustedIrisCoords(rawCoords,leftIrisRawCoords,"left");const adjustedRightIrisCoords=this.getAdjustedIrisCoords(rawCoords,rightIrisRawCoords,"right");rawCoords=rawCoords.concat(adjustedLeftIrisCoords).concat(adjustedRightIrisCoords)}const transformedCoordsData=this.transformRawCoords(rawCoords,box,angle,rotationMatrix);const transformedCoords=tfjs.tensor2d(transformedCoordsData);const landmarksBox=enlargeBox(this.calculateLandmarksBoundingBox(transformedCoordsData));const squarifiedLandmarksBox=squarifyBox(landmarksBox);this.regionsOfInterest[i]={...squarifiedLandmarksBox,landmarks:transformedCoords.arraySync()};const prediction={coords:tfjs.tensor2d(rawCoords,[rawCoords.length,3]),scaledCoords:transformedCoords,box:landmarksBox,flag:tfjs.squeeze(flag)};return prediction}))))}updateRegionsOfInterest(boxes){for(let i=0;i<boxes.length;i++){const box=boxes[i];const previousBox=this.regionsOfInterest[i];let iou=0;if(previousBox&&previousBox.startPoint){const[boxStartX,boxStartY]=box.startPoint;const[boxEndX,boxEndY]=box.endPoint;const[previousBoxStartX,previousBoxStartY]=previousBox.startPoint;const[previousBoxEndX,previousBoxEndY]=previousBox.endPoint;const xStartMax=Math.max(boxStartX,previousBoxStartX);const yStartMax=Math.max(boxStartY,previousBoxStartY);const xEndMin=Math.min(boxEndX,previousBoxEndX);const yEndMin=Math.min(boxEndY,previousBoxEndY);const intersection=(xEndMin-xStartMax)*(yEndMin-yStartMax);const boxArea=(boxEndX-boxStartX)*(boxEndY-boxStartY);const previousBoxArea=(previousBoxEndX-previousBoxStartX)*(previousBoxEndY-boxStartY);iou=intersection/(boxArea+previousBoxArea-intersection)}if(iou<UPDATE_REGION_OF_INTEREST_IOU_THRESHOLD){this.regionsOfInterest[i]=box}}this.regionsOfInterest=this.regionsOfInterest.slice(0,boxes.length)}clearRegionOfInterest(index){if(this.regionsOfInterest[index]!=null){this.regionsOfInterest=[...this.regionsOfInterest.slice(0,index),...this.regionsOfInterest.slice(index+1)]}}shouldUpdateRegionsOfInterest(){const roisCount=this.regionsOfInterest.length;const noROIs=roisCount===0;if(this.maxFaces===1||noROIs){return noROIs}return roisCount!==this.maxFaces&&this.runsWithoutFaceDetector>=this.maxContinuousChecks}calculateLandmarksBoundingBox(landmarks){const xs=landmarks.map((d=>d[0]));const ys=landmarks.map((d=>d[1]));const startPoint=[Math.min(...xs),Math.min(...ys)];const endPoint=[Math.max(...xs),Math.max(...ys)];return{startPoint:startPoint,endPoint:endPoint}}}const UV_COORDS=[[.499976992607117,.652534008026123],[.500025987625122,.547487020492554],[.499974012374878,.602371990680695],[.482113003730774,.471979022026062],[.500150978565216,.527155995368958],[.499909996986389,.498252987861633],[.499523013830185,.40106201171875],[.289712011814117,.380764007568359],[.499954998493195,.312398016452789],[.499987006187439,.269918978214264],[.500023007392883,.107050001621246],[.500023007392883,.666234016418457],[.5000159740448,.679224014282227],[.500023007392883,.692348003387451],[.499976992607117,.695277988910675],[.499976992607117,.70593398809433],[.499976992607117,.719385027885437],[.499976992607117,.737019002437592],[.499967992305756,.781370997428894],[.499816000461578,.562981009483337],[.473773002624512,.573909997940063],[.104906998574734,.254140973091125],[.365929991006851,.409575998783112],[.338757991790771,.41302502155304],[.311120003461838,.409460008144379],[.274657994508743,.389131009578705],[.393361985683441,.403706014156342],[.345234006643295,.344011008739471],[.370094001293182,.346076011657715],[.319321990013123,.347265005111694],[.297903001308441,.353591024875641],[.24779200553894,.410809993743896],[.396889001131058,.842755019664764],[.280097991228104,.375599980354309],[.106310002505779,.399955987930298],[.2099249958992,.391353011131287],[.355807989835739,.534406006336212],[.471751004457474,.65040397644043],[.474155008792877,.680191993713379],[.439785003662109,.657229006290436],[.414617002010345,.66654098033905],[.450374007225037,.680860996246338],[.428770989179611,.682690978050232],[.374971002340317,.727805018424988],[.486716985702515,.547628998756409],[.485300987958908,.527395009994507],[.257764995098114,.314490020275116],[.401223003864288,.455172002315521],[.429818987846375,.548614978790283],[.421351999044418,.533740997314453],[.276895999908447,.532056987285614],[.483370006084442,.499586999416351],[.33721199631691,.282882988452911],[.296391993761063,.293242990970612],[.169294998049736,.193813979625702],[.447580009698868,.302609980106354],[.392390012741089,.353887975215912],[.354490011930466,.696784019470215],[.067304998636246,.730105042457581],[.442739009857178,.572826027870178],[.457098007202148,.584792017936707],[.381974011659622,.694710969924927],[.392388999462128,.694203019142151],[.277076005935669,.271932005882263],[.422551989555359,.563233017921448],[.385919004678726,.281364023685455],[.383103013038635,.255840003490448],[.331431001424789,.119714021682739],[.229923993349075,.232002973556519],[.364500999450684,.189113974571228],[.229622006416321,.299540996551514],[.173287004232407,.278747975826263],[.472878992557526,.666198015213013],[.446828007698059,.668527007102966],[.422762006521225,.673889994621277],[.445307999849319,.580065965652466],[.388103008270264,.693961024284363],[.403039008378983,.706539988517761],[.403629004955292,.693953037261963],[.460041999816895,.557139039039612],[.431158006191254,.692366003990173],[.452181994915009,.692366003990173],[.475387006998062,.692366003990173],[.465828001499176,.779190003871918],[.472328990697861,.736225962638855],[.473087012767792,.717857003211975],[.473122000694275,.704625964164734],[.473033010959625,.695277988910675],[.427942007780075,.695277988910675],[.426479011774063,.703539967536926],[.423162013292313,.711845993995667],[.4183090031147,.720062971115112],[.390094995498657,.639572978019714],[.013953999616206,.560034036636353],[.499913990497589,.58014702796936],[.413199990987778,.69539999961853],[.409626007080078,.701822996139526],[.468080013990402,.601534962654114],[.422728985548019,.585985004901886],[.463079988956451,.593783974647522],[.37211999297142,.47341400384903],[.334562003612518,.496073007583618],[.411671012639999,.546965003013611],[.242175996303558,.14767599105835],[.290776997804642,.201445996761322],[.327338010072708,.256527006626129],[.399509996175766,.748921036720276],[.441727995872498,.261676013469696],[.429764986038208,.187834024429321],[.412198007106781,.108901023864746],[.288955003023148,.398952007293701],[.218936994671822,.435410976409912],[.41278201341629,.398970007896423],[.257135003805161,.355440020561218],[.427684992551804,.437960982322693],[.448339998722076,.536936044692993],[.178560003638268,.45755398273468],[.247308000922203,.457193970680237],[.286267012357712,.467674970626831],[.332827985286713,.460712015628815],[.368755996227264,.447206974029541],[.398963987827301,.432654976844788],[.476410001516342,.405806005001068],[.189241006970406,.523923993110657],[.228962004184723,.348950982093811],[.490725994110107,.562400996685028],[.404670000076294,.485132992267609],[.019469000399113,.401564002037048],[.426243007183075,.420431017875671],[.396993011236191,.548797011375427],[.266469985246658,.376977026462555],[.439121007919312,.51895797252655],[.032313998788595,.644356966018677],[.419054001569748,.387154996395111],[.462783008813858,.505746960639954],[.238978996872902,.779744982719421],[.198220998048782,.831938028335571],[.107550002634525,.540755033493042],[.183610007166862,.740257024765015],[.134409993886948,.333683013916016],[.385764002799988,.883153975009918],[.490967005491257,.579378008842468],[.382384985685349,.508572995662689],[.174399003386497,.397670984268188],[.318785011768341,.39623498916626],[.343364000320435,.400596976280212],[.396100014448166,.710216999053955],[.187885001301765,.588537991046906],[.430987000465393,.944064974784851],[.318993002176285,.898285031318665],[.266247987747192,.869701027870178],[.500023007392883,.190576016902924],[.499976992607117,.954452991485596],[.366169989109039,.398822009563446],[.393207013607025,.39553701877594],[.410373002290726,.391080021858215],[.194993004202843,.342101991176605],[.388664990663528,.362284004688263],[.365961998701096,.355970978736877],[.343364000320435,.355356991291046],[.318785011768341,.35834002494812],[.301414996385574,.363156020641327],[.058132998645306,.319076001644135],[.301414996385574,.387449026107788],[.499987989664078,.618434011936188],[.415838003158569,.624195992946625],[.445681989192963,.566076993942261],[.465844005346298,.620640993118286],[.49992299079895,.351523995399475],[.288718998432159,.819945991039276],[.335278987884521,.852819979190826],[.440512001514435,.902418971061707],[.128294005990028,.791940987110138],[.408771991729736,.373893976211548],[.455606997013092,.451801002025604],[.499877005815506,.908990025520325],[.375436991453171,.924192011356354],[.11421000212431,.615022003650665],[.448662012815475,.695277988910675],[.4480200111866,.704632043838501],[.447111994028091,.715808033943176],[.444831997156143,.730794012546539],[.430011987686157,.766808986663818],[.406787008047104,.685672998428345],[.400738000869751,.681069016456604],[.392399996519089,.677703022956848],[.367855995893478,.663918972015381],[.247923001646996,.601333022117615],[.452769994735718,.420849978923798],[.43639200925827,.359887003898621],[.416164010763168,.368713974952698],[.413385987281799,.692366003990173],[.228018000721931,.683571994304657],[.468268007040024,.352671027183533],[.411361992359161,.804327011108398],[.499989002943039,.469825029373169],[.479153990745544,.442654013633728],[.499974012374878,.439637005329132],[.432112008333206,.493588984012604],[.499886006116867,.866917014122009],[.49991300702095,.821729004383087],[.456548988819122,.819200992584229],[.344549000263214,.745438992977142],[.37890899181366,.574010014533997],[.374292999505997,.780184984207153],[.319687992334366,.570737957954407],[.357154995203018,.604269981384277],[.295284003019333,.621580958366394],[.447750002145767,.862477004528046],[.410986006259918,.508723020553589],[.31395098567009,.775308012962341],[.354128003120422,.812552988529205],[.324548006057739,.703992962837219],[.189096003770828,.646299958229065],[.279776990413666,.71465802192688],[.1338230073452,.682700991630554],[.336768001317978,.644733011722565],[.429883986711502,.466521978378296],[.455527991056442,.548622965812683],[.437114000320435,.558896005153656],[.467287987470627,.529924988746643],[.414712011814117,.335219979286194],[.37704598903656,.322777986526489],[.344107985496521,.320150971412659],[.312875986099243,.32233202457428],[.283526003360748,.333190023899078],[.241245999932289,.382785975933075],[.102986000478268,.468762993812561],[.267612010240555,.424560010433197],[.297879010438919,.433175981044769],[.333433985710144,.433878004550934],[.366427004337311,.426115989685059],[.396012008190155,.416696012020111],[.420121014118195,.41022801399231],[.007561000064015,.480777025222778],[.432949006557465,.569517970085144],[.458638995885849,.479089021682739],[.473466008901596,.545744001865387],[.476087987422943,.563830018043518],[.468472003936768,.555056989192963],[.433990985155106,.582361996173859],[.483518004417419,.562983989715576],[.482482999563217,.57784903049469],[.42645001411438,.389798998832703],[.438998997211456,.39649498462677],[.450067013502121,.400434017181396],[.289712011814117,.368252992630005],[.276670008897781,.363372981548309],[.517862021923065,.471948027610779],[.710287988185883,.380764007568359],[.526226997375488,.573909997940063],[.895093023777008,.254140973091125],[.634069979190826,.409575998783112],[.661242008209229,.41302502155304],[.688880026340485,.409460008144379],[.725341975688934,.389131009578705],[.606630027294159,.40370500087738],[.654766023159027,.344011008739471],[.629905998706818,.346076011657715],[.680678009986877,.347265005111694],[.702096998691559,.353591024875641],[.75221198797226,.410804986953735],[.602918028831482,.842862963676453],[.719901978969574,.375599980354309],[.893692970275879,.399959981441498],[.790081977844238,.391354024410248],[.643998026847839,.534487962722778],[.528249025344849,.65040397644043],[.525849997997284,.680191040039062],[.560214996337891,.657229006290436],[.585384011268616,.66654098033905],[.549625992774963,.680860996246338],[.57122802734375,.682691991329193],[.624852001667023,.72809898853302],[.513050019741058,.547281980514526],[.51509702205658,.527251958847046],[.742246985435486,.314507007598877],[.598631024360657,.454979002475739],[.570338010787964,.548575043678284],[.578631997108459,.533622980117798],[.723087012767792,.532054007053375],[.516445994377136,.499638974666595],[.662801027297974,.282917976379395],[.70362401008606,.293271005153656],[.830704987049103,.193813979625702],[.552385985851288,.302568018436432],[.607609987258911,.353887975215912],[.645429015159607,.696707010269165],[.932694971561432,.730105042457581],[.557260990142822,.572826027870178],[.542901992797852,.584792017936707],[.6180260181427,.694710969924927],[.607590973377228,.694203019142151],[.722943007946014,.271963000297546],[.577413976192474,.563166975975037],[.614082992076874,.281386971473694],[.616907000541687,.255886018276215],[.668509006500244,.119913995265961],[.770092010498047,.232020974159241],[.635536015033722,.189248979091644],[.77039098739624,.299556016921997],[.826722025871277,.278755009174347],[.527121007442474,.666198015213013],[.553171992301941,.668527007102966],[.577238023281097,.673889994621277],[.554691970348358,.580065965652466],[.611896991729736,.693961024284363],[.59696102142334,.706539988517761],[.596370995044708,.693953037261963],[.539958000183105,.557139039039612],[.568841993808746,.692366003990173],[.547818005084991,.692366003990173],[.52461302280426,.692366003990173],[.534089982509613,.779141008853912],[.527670979499817,.736225962638855],[.526912987232208,.717857003211975],[.526877999305725,.704625964164734],[.526966989040375,.695277988910675],[.572058022022247,.695277988910675],[.573521018028259,.703539967536926],[.57683801651001,.711845993995667],[.581691026687622,.720062971115112],[.609944999217987,.639909982681274],[.986046016216278,.560034036636353],[.5867999792099,.69539999961853],[.590372025966644,.701822996139526],[.531915009021759,.601536989212036],[.577268004417419,.585934996604919],[.536915004253387,.593786001205444],[.627542972564697,.473352015018463],[.665585994720459,.495950996875763],[.588353991508484,.546862006187439],[.757824003696442,.14767599105835],[.709249973297119,.201507985591888],[.672684013843536,.256581008434296],[.600408971309662,.74900496006012],[.55826598405838,.261672019958496],[.570303976535797,.187870979309082],[.588165998458862,.109044015407562],[.711045026779175,.398952007293701],[.781069993972778,.435405015945435],[.587247014045715,.398931980133057],[.742869973182678,.355445981025696],[.572156012058258,.437651991844177],[.55186802148819,.536570012569427],[.821442008018494,.457556009292603],[.752701997756958,.457181990146637],[.71375697851181,.467626988887787],[.66711300611496,.460672974586487],[.631101012229919,.447153985500336],[.6008620262146,.432473003864288],[.523481011390686,.405627012252808],[.810747981071472,.523926019668579],[.771045982837677,.348959028720856],[.509127020835876,.562718033790588],[.595292985439301,.485023975372314],[.980530977249146,.401564002037048],[.573499977588654,.420000016689301],[.602994978427887,.548687994480133],[.733529984951019,.376977026462555],[.560611009597778,.519016981124878],[.967685997486115,.644356966018677],[.580985009670258,.387160003185272],[.537728011608124,.505385041236877],[.760966002941132,.779752969741821],[.801778972148895,.831938028335571],[.892440974712372,.54076099395752],[.816350996494293,.740260004997253],[.865594983100891,.333687007427216],[.614073991775513,.883246004581451],[.508952975273132,.579437971115112],[.617941975593567,.508316040039062],[.825608015060425,.397674977779388],[.681214988231659,.39623498916626],[.656635999679565,.400596976280212],[.603900015354156,.710216999053955],[.81208598613739,.588539004325867],[.56801301240921,.944564998149872],[.681007981300354,.898285031318665],[.733752012252808,.869701027870178],[.633830010890961,.398822009563446],[.606792986392975,.39553701877594],[.589659988880157,.391062021255493],[.805015981197357,.342108011245728],[.611334979534149,.362284004688263],[.634037971496582,.355970978736877],[.656635999679565,.355356991291046],[.681214988231659,.35834002494812],[.698584973812103,.363156020641327],[.941866993904114,.319076001644135],[.698584973812103,.387449026107788],[.584177017211914,.624107003211975],[.554318010807037,.566076993942261],[.534153997898102,.62064003944397],[.711217999458313,.819975018501282],[.664629995822906,.852871000766754],[.559099972248077,.902631998062134],[.871706008911133,.791940987110138],[.591234028339386,.373893976211548],[.544341027736664,.451583981513977],[.624562978744507,.924192011356354],[.88577002286911,.615028977394104],[.551338016986847,.695277988910675],[.551980018615723,.704632043838501],[.552887976169586,.715808033943176],[.555167973041534,.730794012546539],[.569944024085999,.767035007476807],[.593203008174896,.685675978660583],[.599261999130249,.681069016456604],[.607599973678589,.677703022956848],[.631937980651855,.663500010967255],[.752032995223999,.601315021514893],[.547226011753082,.420395016670227],[.563543975353241,.359827995300293],[.583841025829315,.368713974952698],[.586614012718201,.692366003990173],[.771915018558502,.683578014373779],[.531597018241882,.352482974529266],[.588370978832245,.804440975189209],[.52079701423645,.442565023899078],[.567984998226166,.493479013442993],[.543282985687256,.819254994392395],[.655317008495331,.745514988899231],[.621008992195129,.574018001556396],[.625559985637665,.78031200170517],[.680198013782501,.570719003677368],[.64276397228241,.604337990283966],[.704662978649139,.621529996395111],[.552012026309967,.862591981887817],[.589071989059448,.508637011051178],[.685944974422455,.775357007980347],[.645735025405884,.812640011310577],[.675342977046967,.703978002071381],[.810858011245728,.646304965019226],[.72012197971344,.714666962623596],[.866151988506317,.682704985141754],[.663187026977539,.644596993923187],[.570082008838654,.466325998306274],[.544561982154846,.548375964164734],[.562758982181549,.558784961700439],[.531987011432648,.530140042304993],[.585271000862122,.335177004337311],[.622952997684479,.32277899980545],[.655896008014679,.320163011550903],[.687132000923157,.322345972061157],[.716481983661652,.333200991153717],[.758756995201111,.382786989212036],[.897013008594513,.468769013881683],[.732392013072968,.424547016620636],[.70211398601532,.433162987232208],[.66652500629425,.433866024017334],[.633504986763,.426087975502014],[.603875994682312,.416586995124817],[.579657971858978,.409945011138916],[.992439985275269,.480777025222778],[.567192018032074,.569419980049133],[.54136598110199,.478899002075195],[.526564002037048,.546118021011353],[.523913025856018,.563830018043518],[.531529009342194,.555056989192963],[.566035985946655,.582329034805298],[.51631098985672,.563053965568542],[.5174720287323,.577877044677734],[.573594987392426,.389806985855103],[.560697972774506,.395331978797913],[.549755990505219,.399751007556915],[.710287988185883,.368252992630005],[.723330020904541,.363372981548309]];const FACEMESH_GRAPHMODEL_PATH="https://tfhub.dev/mediapipe/tfjs-model/facemesh/1/default/1";const IRIS_GRAPHMODEL_PATH="https://tfhub.dev/mediapipe/tfjs-model/iris/1/default/2";const MESH_MODEL_INPUT_WIDTH=192;const MESH_MODEL_INPUT_HEIGHT=192;const PREDICTION_VALUES="MediaPipePredictionValues";const PREDICTION_TENSORS="MediaPipePredictionTensors";async function load$1(config){const{maxContinuousChecks:maxContinuousChecks=5,detectionConfidence:detectionConfidence=.9,maxFaces:maxFaces=10,iouThreshold:iouThreshold=.3,scoreThreshold:scoreThreshold=.75,shouldLoadIrisModel:shouldLoadIrisModel=true,modelUrl:modelUrl,detectorModelUrl:detectorModelUrl,irisModelUrl:irisModelUrl}=config;let models;if(shouldLoadIrisModel){models=await Promise.all([loadDetectorModel(detectorModelUrl,maxFaces,iouThreshold,scoreThreshold),loadMeshModel(modelUrl),loadIrisModel(irisModelUrl)])}else{models=await Promise.all([loadDetectorModel(detectorModelUrl,maxFaces,iouThreshold,scoreThreshold),loadMeshModel(modelUrl)])}const faceMesh=new FaceMesh(models[0],models[1],maxContinuousChecks,detectionConfidence,maxFaces,shouldLoadIrisModel?models[2]:null);return faceMesh}async function loadDetectorModel(modelUrl,maxFaces,iouThreshold,scoreThreshold){return index.load({modelUrl:modelUrl,maxFaces:maxFaces,iouThreshold:iouThreshold,scoreThreshold:scoreThreshold})}async function loadMeshModel(modelUrl){if(modelUrl!=null){return tfjs.loadGraphModel(modelUrl)}return tfjs.loadGraphModel(FACEMESH_GRAPHMODEL_PATH,{fromTFHub_:true})}async function loadIrisModel(modelUrl){if(modelUrl!=null){return tfjs.loadGraphModel(modelUrl)}return tfjs.loadGraphModel(IRIS_GRAPHMODEL_PATH,{fromTFHub:true})}function getInputTensorDimensions(input){return input instanceof tfjs.Tensor?[input.shape[0],input.shape[1]]:[input.height,input.width]}function flipFaceHorizontal(face,imageWidth){if(face.mesh instanceof tfjs.Tensor){const[topLeft,bottomRight,mesh,scaledMesh]=tfjs.tidy((()=>{const subtractBasis=tfjs.tensor1d([imageWidth-1,0,0]);const multiplyBasis=tfjs.tensor1d([1,-1,1]);return tfjs.tidy((()=>[tfjs.concat([tfjs.sub(imageWidth-1,tfjs.slice(face.boundingBox.topLeft,0,1)),tfjs.slice(face.boundingBox.topLeft,1,1)]),tfjs.concat([tfjs.sub(imageWidth-1,tfjs.slice(face.boundingBox.bottomRight,0,1)),tfjs.slice(face.boundingBox.bottomRight,1,1)]),tfjs.mul(tfjs.sub(subtractBasis,face.mesh),multiplyBasis),tfjs.mul(tfjs.sub(subtractBasis,face.scaledMesh),multiplyBasis)]))}));return Object.assign({},face,{boundingBox:{topLeft:topLeft,bottomRight:bottomRight},mesh:mesh,scaledMesh:scaledMesh})}return Object.assign({},face,{boundingBox:{topLeft:[imageWidth-1-face.boundingBox.topLeft[0],face.boundingBox.topLeft[1]],bottomRight:[imageWidth-1-face.boundingBox.bottomRight[0],face.boundingBox.bottomRight[1]]},mesh:face.mesh.map((coord=>{const flippedCoord=coord.slice(0);flippedCoord[0]=imageWidth-1-coord[0];return flippedCoord})),scaledMesh:face.scaledMesh.map((coord=>{const flippedCoord=coord.slice(0);flippedCoord[0]=imageWidth-1-coord[0];return flippedCoord}))})}class FaceMesh{constructor(blazeFace,blazeMeshModel,maxContinuousChecks,detectionConfidence,maxFaces,irisModel){this.kind="MediaPipeFaceMesh";this.pipeline=new Pipeline(blazeFace,blazeMeshModel,MESH_MODEL_INPUT_WIDTH,MESH_MODEL_INPUT_HEIGHT,maxContinuousChecks,maxFaces,irisModel);this.detectionConfidence=detectionConfidence}static getAnnotations(){return MESH_ANNOTATIONS}static getUVCoords(){return UV_COORDS}estimateFaces(config){const{returnTensors:returnTensors=false,flipHorizontal:flipHorizontal=false,predictIrises:predictIrises=true}=config;let input=config.input;if(predictIrises&&this.pipeline.irisModel==null){throw new Error("The iris model was not loaded as part of facemesh. Please initialize the model with facemesh.load({shouldLoadIrisModel: true}).")}const[,width]=getInputTensorDimensions(input);const image=tfjs.tidy((()=>{if(!(input instanceof tfjs.Tensor)){input=tfjs.fromPixels(input)}return tfjs.expandDims(tfjs.cast(input,"float32"),0)}));let predictions;if(tfjs.getBackend()==="webgl"){const savedWebglPackDepthwiseConvFlag=tfjs.env().get("WEBGL_PACK_DEPTHWISECONV");tfjs.env().set("WEBGL_PACK_DEPTHWISECONV",true);predictions=this.pipeline.predict(image,predictIrises);tfjs.env().set("WEBGL_PACK_DEPTHWISECONV",savedWebglPackDepthwiseConvFlag)}else{predictions=this.pipeline.predict(image,predictIrises)}image.dispose();if(predictions!=null&&predictions.length>0){return predictions.map(((prediction,i)=>{const{coords:coords,scaledCoords:scaledCoords,box:box,flag:flag}=prediction;let tensorsToRead=[flag];if(!returnTensors){tensorsToRead=tensorsToRead.concat([coords,scaledCoords])}const tensorValues=tensorsToRead.map((d=>d.arraySync()));const flagValue=tensorValues[0];flag.dispose();if(flagValue<this.detectionConfidence){this.pipeline.clearRegionOfInterest(i)}if(returnTensors){const annotatedPrediction2={kind:PREDICTION_TENSORS,faceInViewConfidence:flagValue,mesh:coords,scaledMesh:scaledCoords,boundingBox:{topLeft:tfjs.tensor1d(box.startPoint),bottomRight:tfjs.tensor1d(box.endPoint)}};if(flipHorizontal){return flipFaceHorizontal(annotatedPrediction2,width)}return annotatedPrediction2}const[coordsArr,coordsArrScaled]=tensorValues.slice(1);scaledCoords.dispose();coords.dispose();let annotatedPrediction={kind:PREDICTION_VALUES,faceInViewConfidence:flagValue,boundingBox:{topLeft:box.startPoint,bottomRight:box.endPoint},mesh:coordsArr,scaledMesh:coordsArrScaled};if(flipHorizontal){annotatedPrediction=flipFaceHorizontal(annotatedPrediction,width)}const annotations={};for(const key in MESH_ANNOTATIONS){if(predictIrises||key.includes("Iris")===false){annotations[key]=MESH_ANNOTATIONS[key].map((index=>annotatedPrediction.scaledMesh[index]))}}annotatedPrediction["annotations"]=annotations;return annotatedPrediction}))}return[]}}var SupportedPackages;(function(SupportedPackages2){SupportedPackages2["mediapipeFacemesh"]="mediapipe-facemesh"})(SupportedPackages||(SupportedPackages={}));async function load(pkg=SupportedPackages.mediapipeFacemesh,config={}){if(pkg===SupportedPackages.mediapipeFacemesh){return load$1(config)}else{throw new Error(`${pkg} is not a valid package name.`)}}const NUM_KEYPOINTS=468;const GREEN="#32EEDB";const RED="#FF2C35";function distance(a,b){return Math.sqrt(Math.pow(a[0]-b[0],2)+Math.pow(a[1]-b[1],2))}Page({helper:null,async onReady(){console.log("face-landmarks onReady");await tfjs.ready();console.log("tf ready");const helper=this.selectComponent("#helper");console.log("face-landmarks load start");const model=await load(SupportedPackages.mediapipeFacemesh,{maxFaces:1,modelUrl:"https://cdn.static.oppenlab.com/weblf/test/facemesh/model.json",shouldLoadIrisModel:false});console.log("face-landmarks load end");const onFrame=(frame,deps)=>{const{ctx:ctx}=deps;const video={width:frame.width,height:frame.height,data:new Uint8Array(frame.data)};const t=Date.now();const predictions=model.estimateFaces({input:video,returnTensors:false,flipHorizontal:false,predictIrises:false});console.log("predict cost",Date.now()-t);helper.drawCanvas2D(frame);if(predictions.length>0){predictions.forEach((prediction=>{const keypoints=prediction.scaledMesh;ctx.fillStyle=GREEN;for(let i=0;i<NUM_KEYPOINTS;i++){const x=keypoints[i][0];const y=keypoints[i][1];ctx.beginPath();ctx.arc(x,y,1,0,2*Math.PI);ctx.fill()}if(keypoints.length>NUM_KEYPOINTS){ctx.strokeStyle=RED;ctx.lineWidth=1;const leftCenter=keypoints[NUM_KEYPOINTS];const leftDiameterY=distance(keypoints[NUM_KEYPOINTS+4],keypoints[NUM_KEYPOINTS+2]);const leftDiameterX=distance(keypoints[NUM_KEYPOINTS+3],keypoints[NUM_KEYPOINTS+1]);ctx.beginPath();ctx.ellipse(leftCenter[0],leftCenter[1],leftDiameterX/2,leftDiameterY/2,0,0,2*Math.PI);ctx.stroke()}}))}};helper.set({onFrame:onFrame});this.helper=helper},onShow:function(){var _a;(_a=this.helper)==null?void 0:_a.start()},onHide:function(){var _a;(_a=this.helper)==null?void 0:_a.stop()},onUnload:function(){},onShareAppMessage:function(){}});
