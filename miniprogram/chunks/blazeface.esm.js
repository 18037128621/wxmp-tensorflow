"use strict";var t=require("./tfjs.js");function e(t,e,n,r){return new(n||(n=Promise))((function(i,o){function s(t){try{c(r.next(t))}catch(t){o(t)}}function a(t){try{c(r.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((r=r.apply(t,e||[])).next())}))}function n(t,e){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}var r=function(e){return{startEndTensor:e,startPoint:t.slice(e,[0,0],[-1,2]),endPoint:t.slice(e,[0,2],[-1,2])}},i={strides:[8,16],anchors:[2,6]};function o(e,n){var r,i,o;if(e.topLeft instanceof t.Tensor&&e.bottomRight instanceof t.Tensor){var s=t.tidy((function(){return[t.concat([t.slice(t.sub(n-1,e.topLeft),0,1),t.slice(e.topLeft,1,1)]),t.concat([t.sub(n-1,t.slice(e.bottomRight,0,1)),t.slice(e.bottomRight,1,1)])]}));r=s[0],i=s[1],null!=e.landmarks&&(o=t.tidy((function(){var r=t.sub(t.tensor1d([n-1,0]),e.landmarks),i=t.tensor1d([1,-1]);return t.mul(r,i)})))}else{var a=e.topLeft,c=a[0],u=a[1],l=e.bottomRight,d=l[0],h=l[1];r=[n-1-c,u],i=[n-1-d,h],null!=e.landmarks&&(o=e.landmarks.map((function(t){return[n-1-t[0],t[1]]})))}var f={topLeft:r,bottomRight:i};return null!=o&&(f.landmarks=o),null!=e.probability&&(f.probability=e.probability instanceof t.Tensor?e.probability.clone():e.probability),f}function s(e,n){return t.tidy((function(){var i;return i=e.hasOwnProperty("box")?e.box:e,t.squeeze(function(e,n){var i=t.mul(e.startPoint,n),o=t.mul(e.endPoint,n),s=t.concat2d([i,o],1);return r(s)}(i,n).startEndTensor)}))}var a=function(){function a(e,n,r,o,s,a){this.blazeFaceModel=e,this.width=n,this.height=r,this.maxFaces=o,this.anchorsData=function(t,e,n){for(var r=[],i=0;i<n.strides.length;i++)for(var o=n.strides[i],s=Math.floor((e+o-1)/o),a=Math.floor((t+o-1)/o),c=n.anchors[i],u=0;u<s;u++)for(var l=o*(u+.5),d=0;d<a;d++)for(var h=o*(d+.5),f=0;f<c;f++)r.push([h,l]);return r}(n,r,i),this.anchors=t.tensor2d(this.anchorsData),this.inputSizeData=[n,r],this.inputSize=t.tensor1d([n,r]),this.iouThreshold=s,this.scoreThreshold=a}return a.prototype.getBoundingBoxes=function(i,o,s){return void 0===s&&(s=!0),e(this,void 0,void 0,(function(){var a,c,u,l,d,h,f,p,b,v,m,y,g,w,x=this;return n(this,(function(T){switch(T.label){case 0:return a=t.tidy((function(){var e=t.image.resizeBilinear(i,[x.width,x.height]),n=t.mul(t.sub(t.div(e,255),.5),2),r=x.blazeFaceModel.predict(n),o=t.squeeze(r),s=function(e,n,r){var i=t.slice(e,[0,1],[-1,2]),o=t.add(i,n),s=t.slice(e,[0,3],[-1,2]),a=t.div(s,r),c=t.div(o,r),u=t.div(a,2),l=t.sub(c,u),d=t.add(c,u),h=t.mul(l,r),f=t.mul(d,r);return t.concat2d([h,f],1)}(o,x.anchors,x.inputSize),a=t.slice(o,[0,0],[-1,1]);return[o,s,t.squeeze(t.sigmoid(a))]})),c=a[0],u=a[1],l=a[2],d=console.warn,console.warn=function(){},h=t.image.nonMaxSuppression(u,l,this.maxFaces,this.iouThreshold,this.scoreThreshold),console.warn=d,[4,h.array()];case 1:return f=T.sent(),h.dispose(),p=f.map((function(e){return t.slice(u,[e,0],[1,-1])})),o?[3,3]:[4,Promise.all(p.map((function(t){return e(x,void 0,void 0,(function(){var e;return n(this,(function(n){switch(n.label){case 0:return[4,t.array()];case 1:return e=n.sent(),t.dispose(),[2,e]}}))}))})))];case 2:p=T.sent(),T.label=3;case 3:for(b=i.shape[1],v=i.shape[2],m=o?t.div([v,b],this.inputSize):[v/this.inputSizeData[0],b/this.inputSizeData[1]],y=[],g=function(e){var n=p[e],i=t.tidy((function(){var i=r(n instanceof t.Tensor?n:t.tensor2d(n));if(!s)return i;var a,u=f[e];return a=o?t.slice(x.anchors,[u,0],[1,2]):x.anchorsData[u],{box:i,landmarks:t.reshape(t.squeeze(t.slice(c,[u,5],[1,-1])),[6,-1]),probability:t.slice(l,[u],[1]),anchor:a}}));y.push(i)},w=0;w<p.length;w++)g(w);return u.dispose(),l.dispose(),c.dispose(),[2,{boxes:y,scaleFactor:m}]}}))}))},a.prototype.estimateFaces=function(r,i,a,c){return void 0===i&&(i=!1),void 0===a&&(a=!1),void 0===c&&(c=!0),e(this,void 0,void 0,(function(){var u,l,d,h,f,p,b=this;return n(this,(function(v){switch(v.label){case 0:return u=function(e){return e instanceof t.Tensor?[e.shape[0],e.shape[1]]:[e.height,e.width]}(r),l=u[1],d=t.tidy((function(){return r instanceof t.Tensor||(r=t.fromPixels(r)),t.expandDims(t.cast(r,"float32"),0)})),[4,this.getBoundingBoxes(d,i,c)];case 1:return h=v.sent(),f=h.boxes,p=h.scaleFactor,d.dispose(),i?[2,f.map((function(e){var n=s(e,p),r={topLeft:t.slice(n,[0],[2]),bottomRight:t.slice(n,[2],[2])};if(c){var i=e,u=i.landmarks,d=i.probability,h=i.anchor,f=t.mul(t.add(u,h),p);r.landmarks=f,r.probability=d}return a&&(r=o(r,l)),r}))]:[2,Promise.all(f.map((function(t){return e(b,void 0,void 0,(function(){var r,i,u,d,h,f,b,v,m,y,g,w=this;return n(this,(function(x){switch(x.label){case 0:return r=s(t,p),c?[3,2]:[4,r.array()];case 1:return h=x.sent(),i={topLeft:h.slice(0,2),bottomRight:h.slice(2)},[3,4];case 2:return[4,Promise.all([t.landmarks,r,t.probability].map((function(t){return e(w,void 0,void 0,(function(){return n(this,(function(e){return[2,t.array()]}))}))})))];case 3:u=x.sent(),d=u[0],h=u[1],f=u[2],b=t.anchor,m=(v=p)[0],y=v[1],g=d.map((function(t){return[(t[0]+b[0])*m,(t[1]+b[1])*y]})),i={topLeft:h.slice(0,2),bottomRight:h.slice(2),landmarks:g,probability:f},function(t){t.startEndTensor.dispose(),t.startPoint.dispose(),t.endPoint.dispose()}(t.box),t.landmarks.dispose(),t.probability.dispose(),x.label=4;case 4:return r.dispose(),a&&(i=o(i,l)),[2,i]}}))}))})))]}}))}))},a}();exports.load=function(r){var i=void 0===r?{}:r,o=i.maxFaces,s=void 0===o?10:o,c=i.inputWidth,u=void 0===c?128:c,l=i.inputHeight,d=void 0===l?128:l,h=i.iouThreshold,f=void 0===h?.3:h,p=i.scoreThreshold,b=void 0===p?.75:p,v=i.modelUrl;return e(this,void 0,void 0,(function(){var e;return n(this,(function(n){switch(n.label){case 0:return null==v?[3,2]:[4,t.loadGraphModel(v)];case 1:return e=n.sent(),[3,4];case 2:return[4,t.loadGraphModel("https://cdn.static.oppenlab.com/weblf/test/blazeface/model.json",{fromTFHub_:!0})];case 3:e=n.sent(),n.label=4;case 4:return[2,new a(e,u,d,s,f,b)]}}))}))};
